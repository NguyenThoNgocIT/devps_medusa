services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: medusa
      POSTGRES_USER: medusa
      POSTGRES_PASSWORD: medusa
    ports:
      - 5433:5432
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U medusa -d medusa"]
      interval: 5s
      timeout: 5s
      retries: 12

  redis:
    image: redis:7
    ports:
      - 6380:6379

  medusa:
    build:
      context: ./my-medusa-store
      dockerfile: Dockerfile
    env_file:
      - ./my-medusa-store/.env
    depends_on:
      - postgres
      - redis
    ports:
      - 9000:9000
    volumes:
      # Mount only source code, not node_modules to avoid native binding conflicts
      - ./my-medusa-store/src:/usr/src/app/src:delegated
      - ./my-medusa-store/medusa-config.ts:/usr/src/app/medusa-config.ts:delegated
      - ./my-medusa-store/medusa-config.js:/usr/src/app/medusa-config.js:delegated
      - ./my-medusa-store/.env:/usr/src/app/.env:delegated
      - ./my-medusa-store/tsconfig.json:/usr/src/app/tsconfig.json:delegated
      # Do NOT mount instrumentation files - let them be copied from image to avoid encoding issues
      # Keep node_modules inside container to avoid native binding issues
      - medusa_node_modules:/usr/src/app/node_modules
    # package.json defines "dev": "medusa develop" - use yarn dev
    command: yarn dev
    environment:
      # Override DATABASE_URL for container networking: use the postgres service hostname
      DATABASE_URL: "postgres://medusa:medusa@postgres:5432/medusa?sslmode=disable"
      # Use redis service hostname
      REDIS_URL: "redis://redis:6379"

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - 9090:9090

  grafana:
    image: grafana/grafana:9.0.0
    depends_on:
      - prometheus
    ports:
      - 3000:3000
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
  
volumes:
  pgdata:
  grafana-data:
  medusa_node_modules:
